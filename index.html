<!-- Save as user-app.html -->
<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Earn & Reward â€” Mini App</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <style>
    body{font-family:'Nunito',sans-serif;margin:0;background:#f4f4f9}
    #app{max-width:500px;margin:0 auto}
    .profile-header{padding:20px;display:flex;align-items:center;border-bottom:1px solid #ddd;background:#fff}
    .profile-info{display:flex;gap:12px;align-items:center}
    #user-photo{width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid #007aff}
    main{padding:15px}
    .stat-card{background:#fff;border:1px solid #ddd;padding:15px;border-radius:10px;text-align:center;margin-bottom:12px}
    .task{background:#fff;border:1px solid #ddd;padding:14px;border-radius:10px;margin-bottom:12px;text-align:center}
    .action-btn{background:#007aff;color:#fff;padding:12px;border:none;border-radius:8px;width:100%;cursor:pointer}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;max-width:500px;margin:0 auto;display:flex;justify-content:space-around;background:#fff;border-top:1px solid #ddd}
    .nav-btn{flex:1;padding:10px;border:0;background:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;color:#666}
    .nav-btn.active{color:#007aff;font-weight:700}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-bottom:10px}
    .modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center}
    .modal-content{background:#fff;padding:20px;border-radius:10px;text-align:center}
  </style>
</head>
<body>
  <div id="app">
    <header class="profile-header">
      <div class="profile-info">
        <img id="user-photo" src="https://i.imgur.com/placeholder.png" alt="photo">
        <div>
          <div id="user-name" style="font-weight:700">Loading...</div>
          <div id="user-sub" style="color:#666">Balance: <span id="user-points">0</span> TK</div>
        </div>
      </div>
    </header>

    <main>
      <div id="home" class="page">
        <h2>Dashboard</h2>
        <div class="stat-card"><strong>Daily Ads Watched</strong><div><span id="daily-ads">0</span> / 25</div></div>
        <div class="stat-card"><strong>Referrals</strong><div id="ref-count">0</div></div>
        <div style="background:#fff;padding:12px;border:1px solid #ddd;border-radius:10px;margin-top:10px">
          <div style="font-weight:700">Share your referral</div>
          <input id="referral-link" readonly />
          <button id="copy-ref" class="action-btn" style="margin-top:8px">Copy Referral Link</button>
        </div>
      </div>

      <div id="tasks" class="page" style="display:none">
        <h2>Tasks</h2>
        <div id="tasks-list"></div>
      </div>

      <div id="withdraw" class="page" style="display:none">
        <h2>Withdraw</h2>
        <form id="withdraw-form">
          <label>Method</label>
          <select id="withdraw-method"><option>Bkash</option><option>Nagad</option><option>Payeer</option><option>Binance</option></select>
          <label>Account</label>
          <input id="withdraw-account" required />
          <label>Amount (TK)</label>
          <input id="withdraw-amount" type="number" required />
          <button type="submit" class="action-btn">Request Withdraw</button>
        </form>
      </div>
    </main>

    <nav class="bottom-nav">
      <button class="nav-btn active" data-page="home"><i class="fas fa-home"></i><small>Home</small></button>
      <button class="nav-btn" data-page="tasks"><i class="fas fa-tasks"></i><small>Tasks</small></button>
      <button class="nav-btn" data-page="withdraw"><i class="fas fa-wallet"></i><small>Withdraw</small></button>
    </nav>
  </div>

  <div class="modal" id="loadingModal"><div class="modal-content"><div style="margin-bottom:10px" class="loader"></div><div>Loading...</div></div></div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
  // ---------- CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyD5xn_MTuYWRVG_K4lUDQZD8jaVUrlsS28",
    authDomain: "bangladeshi-bot.firebaseapp.com",
    projectId: "bangladeshi-bot",
    storageBucket: "bangladeshi-bot.appspot.com",
    messagingSenderId: "833553219415",
    appId: "1:833553219415:web:20dd02e645f080d2994812"
  };
  const BOT_TOKEN = "7801565018:AAERNFu6qxoYGYAiwpmo7BJm_yH_rQKDy40";
  const ADMIN_CHAT_ID = "7890928539";
  const BOT_USERNAME = "Money_Digger_Online_bot";
  const GPLINK_API_KEY = "350d6fa8e30f624a0acfeb5b472812124942bc58";

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const $ = id => document.getElementById(id);

  // Navigation
  document.querySelectorAll('.nav-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.querySelectorAll('.page').forEach(p=>p.style.display='none');
      document.getElementById(b.dataset.page).style.display='block';
    });
  });

  let tg = window.Telegram?.WebApp;
  let tgUser = tg?.initDataUnsafe?.user || null;

  async function promptFallbackUser(){
    const id = prompt("Enter test user id");
    const name = prompt("Enter name", "Demo User");
    return {id, first_name: name, username: null, photo_url: `https://i.pravatar.cc/100?u=${id}`};
  }

  async function shortenWithGPLink(longUrl){
    try{
      const res = await fetch("https://api.gplink.co/v1/links",{
        method: "POST",
        headers:{
          "Authorization": "Bearer " + GPLINK_API_KEY,
          "Content-Type":"application/json"
        },
        body: JSON.stringify({ url: longUrl })
      });
      const data = await res.json();
      return data?.data?.link || longUrl;
    }catch(e){
      console.error("GPLink error:", e);
      return longUrl;
    }
  }

  async function init(){
    let user = tgUser;
    if(!user) user = await promptFallbackUser();
    const uid = `tg_${user.id}`;
    const userDocRef = db.collection('users').doc(uid);
    const snap = await userDocRef.get();
    if(!snap.exists){
      await userDocRef.set({id: uid, tgId: String(user.id), name: user.first_name, points: 0, dailyAds: 0, lastAdDate: new Date().toISOString().slice(0,10), referrals: []});
    }
    userDocRef.onSnapshot(async docSnap=>{
      const data = docSnap.data();
      $('user-name').innerText = data.name;
      $('user-points').innerText = data.points;
      $('daily-ads').innerText = data.dailyAds;
      $('ref-count').innerText = (data.referrals||[]).length;
      const longLink = `https://t.me/${BOT_USERNAME}?start=ref_${uid}`;
      const shortLink = await shortenWithGPLink(longLink);
      $('referral-link').value = shortLink;
      window.CURRENT_USER = { uid, ...data };
    });
  }

  // Copy referral
  $('copy-ref').addEventListener('click', ()=>{
    navigator.clipboard.writeText($('referral-link').value);
    alert('Copied!');
  });

  init();
  </script>
</body>
</html>
